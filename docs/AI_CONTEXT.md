# AI CONTEXT & ARCHITECTURAL MAP
> Last Updated: January 30, 2026

## 1. Tech Stack & Versions
- **Core Framework**: Astro 5.15.7 (static site generator)
- **Content Management**: TinaCMS 2.9.0 (headless CMS)
- **Styling**: Tailwind CSS 4.1.17 + DaisyUI 5.3.10
- **State/Data**: Content Collections (Astro), FlexSearch (search indexing)
- **JavaScript Framework**: React 19.2.0 (for interactive components)
- **Markdown Processing**: remark/rehype ecosystem
- **Testing**: Vitest 4.0.8 + Biome 2.3.5
- **Deployment**: Netlify (production), Vercel (staging)

## 2. High-Level Architecture
This is a **static blog site with headless CMS integration** using the following pattern:
- **Astro**: Generates static HTML pages at build time
- **TinaCMS**: Provides visual editing in development (runs alongside Astro)
- **Content Collections**: Markdown-based content stored in `src/content/`
- **Search**: Pre-built FlexSearch index for client-side search
- **React Islands**: Interactive components (search, consent banner, etc.) hydrated on demand

## 3. Critical Data Flows

### Content Management Flow
1. **Editor**: Uses TinaCMS admin interface (`/admin`)
2. **Content Storage**: Markdown files in `src/content/posts/`, `src/content/pages/`, `src/content/projects/`
3. **Build Process**: `tinacms build` → `astro build` → static HTML output
4. **Search Index**: Generated by `scripts/build-search-index.js` during build

### Search Implementation
1. **Build Time**: `build-search-index.js` reads all Markdown files, extracts frontmatter and content
2. **Runtime**: `SearchComponent.tsx` loads `public/search-index.json` and provides fuzzy search
3. **Search Results**: `SearchResults.tsx` renders results with highlighting

### GDPR Consent Flow
1. **Initial Load**: `ConsentBanner.tsx` checks localStorage for consent preferences
2. **User Choice**: Accept/Reject/Customize analytics cookies
3. **Consent Application**: Google Analytics loaded conditionally based on user preference
4. **Persistence**: Preferences stored in `gdpr-consent-preferences` localStorage key

## 4. Key Directory Map
```
src/
├── components/        # Reusable UI components (Astro/React)
├── content/          # Markdown content collections
│   ├── posts/        # Blog posts
│   ├── pages/        # Static pages
│   └── projects/     # Portfolio items
├── layouts/          # Page layouts (BaseLayout.astro)
├── lib/              # Custom remark/rehype plugins
├── styles/           # Global styles (globals.css)
└── test/             # Vitest tests
scripts/
├── build-search-index.js   # Generates search index
└── optimize-images.js     # Image optimization
```

## 5. Developer Guide / Conventions

### Testing
- **Unit Tests**: Vitest in `src/test/` directory
- **Test Commands**: `pnpm run test:run` (CI), `pnpm run test:ui` (UI)
- **Coverage**: `pnpm run test:coverage`

### Styling
- **Tailwind v4**: CSS-based configuration in `src/styles/globals.css`
- **DaisyUI v5**: 29 themes available, configured as CSS plugin
- **Scoped Styles**: Use `@reference` directive in Astro components that use theme variables

### Content Management
- **Frontmatter**: Zod schemas in `src/content/config.ts`
- **CMS Fields**: Custom field definitions in `tina/templates/`
- **Media**: Uploads stored in `public/photos/`

### Build Process
- **Production**: `pnpm run build:production` (lint → test → tinacms build → search index → astro build → verify)
- **Preview**: `pnpm run build:preview` (skips verification)
- **Search Index**: Must be regenerated after content changes

## 6. Known Technical Debt / Watchlist
- **Large Components**: `ConsentBanner.tsx` (205 lines) - complex state management
- **Search Index Generation**: Synchronous file reading in `build-search-index.js` could be optimized
- **Legacy Fields**: WordPress migration fields in content schemas (wordpress_id, categories)
- **TinaCMS Integration**: Critical that `src/pages/admin.astro` is never created (causes redirect loops)
- **Image Optimization**: `scripts/optimize-images.js` handles image processing but could be enhanced

## 7. Key Invariants
- **No External Database**: All content is static Markdown files
- **TinaCMS Admin Route**: `/admin` is handled exclusively by TinaCMS (no Astro route)
- **Search Index Required**: Search functionality depends on pre-built `public/search-index.json`
- **GDPR Compliance**: Analytics only loads with user consent
- **Theme Switching**: System preference detection with localStorage persistence