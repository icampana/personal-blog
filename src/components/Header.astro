---
import { getCollection } from 'astro:content';
import SearchComponent from './SearchComponent';
import ThemeToggle from './ThemeToggle';
import LanguageSwitcher from './LanguageSwitcher';
import MobileMenu from './MobileMenu';
import type { Locale } from '../utils/i18n';
import { getPageUrl } from '../utils/client';
import { getLanguageFromFilename, getCleanSlug, LOCALES } from '../utils/i18n';

interface Props {
  translations?: Partial<Record<Locale, string>>;
  locale?: Locale;
}

const { translations, locale = 'es' } = Astro.props;

// Get all pages for navigation
const pages = await getCollection('pages');

// Group pages by their clean slug (e.g., "about-me")
const pageGroups = new Map<string, typeof pages>();
for (const page of pages) {
  const cleanSlug = getCleanSlug(page.slug);
  if (!pageGroups.has(cleanSlug)) {
    pageGroups.set(cleanSlug, []);
  }
  pageGroups.get(cleanSlug)!.push(page);
}

// Build menu items with best-match strategy
const navPages: { url: string; title: string }[] = [];

for (const [, group] of pageGroups) {
  // Sort by priority: current locale > Spanish > other
  const currentLocalePage = group.find(
    (p) => getLanguageFromFilename(p.id) === locale
  );
  const spanishPage = group.find(
    (p) => getLanguageFromFilename(p.id) === null || getLanguageFromFilename(p.id) === LOCALES.DEFAULT
  );
  
  // Select the best page for content, but always generate URL for current locale
  // This enables the fallback banner to work correctly
  const pageToRender = currentLocalePage || spanishPage || group[0];
  
  if (pageToRender) {
    navPages.push({
      url: getPageUrl(pageToRender, locale),
      title: pageToRender.data.title,
    });
  }
}

const menuItems = [
  { url: locale === 'es' ? '/' : `/${locale}`, title: 'HOME' },
  { url: locale === 'es' ? '/videos' : `/${locale}/videos`, title: 'VIDEOS' },
  { url: locale === 'es' ? '/portafolio' : `/${locale}/portafolio`, title: 'PORTFOLIO' },
  { url: locale === 'es' ? '/archivo' : `/${locale}/archivo`, title: 'ARCHIVE' },
  ...navPages,
];

const siteTitle = 'IV√ÅN GABRIEL';
---

<nav
  class='sticky top-0 z-50 bg-base-100/80 backdrop-blur-md border-b border-base-content/20'>
  <div class='max-w-7xl mx-auto px-6 h-16 flex items-center justify-between'>
    <div class='flex items-center space-x-2'>
      <div class='w-3 h-3 rounded-full bg-[var(--accent-neon)]'></div>
      <span class='mono font-bold tracking-tighter text-xl text-base-content'
        >{siteTitle}</span
      >
    </div>
    <div class='hidden md:flex items-center space-x-8'>
      {
        menuItems.map((item) => (
          <a
            class='mono text-sm font-medium text-base-content hover:text-[var(--accent-neon)] transition-colors'
            href={item.url}>
            {item.title}
          </a>
        ))
      }
    </div>
    <div class='flex items-center space-x-4'>
      <LanguageSwitcher client:load translations={translations} />
      <MobileMenu client:load menuItems={menuItems} />
      <SearchComponent client:load />
      <ThemeToggle client:load />
    </div>
  </div>
</nav>
