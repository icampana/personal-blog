---
import { getCollection } from 'astro:content';
import PostCard from '../../../components/PostCard.astro';
import BlogLayout from '../../../layouts/BlogLayout.astro';
import { getAllTags, getPostsByTag, sortPostsByDate } from '../../../utils/client';
import { getLanguageFromFilename } from '../../../utils/i18n';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts');
  // Filter for French posts only
  const frenchPosts = allPosts.filter(post => getLanguageFromFilename(post.id) === 'fr');

  const allTags = getAllTags(frenchPosts);

  return allTags.map((tag) => ({
    params: { tag: tag.toLowerCase() },
    props: { tag, posts: frenchPosts },
  }));
}

const { tag, posts } = Astro.props;

// Filter by tag using the pre-filtered posts passed from getStaticPaths
const tagPosts = sortPostsByDate(getPostsByTag(posts, tag));

const title = `Articles étiquetés "${tag}"`;
const description = `Tous les articles de blog étiquetés ${tag}`;
---

<BlogLayout title={title} description={description} locale="fr">
  <div class="px-2">
    <div class="mb-8">
      <h1 class="text-4xl font-bold mb-4">
        Articles étiquetés "{tag}"
      </h1>
      <p class="text-lg text-base-content/70">
        {tagPosts.length} {tagPosts.length === 1 ? 'article trouvé' : 'articles trouvés'}
      </p>
    </div>

    {tagPosts.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {tagPosts.map((post) => (
          <PostCard post={post} locale="fr" />
        ))}
      </div>
    ) : (
      <div class="text-center py-12">
        <p class="text-xl text-base-content/60 mb-4">
          Aucun article trouvé avec cette étiquette.
        </p>
        <a href="/fr/tag" class="btn btn-primary">
          Voir toutes les étiquettes
        </a>
      </div>
    )}

    <div class="mt-12 text-center">
      <a href="/fr/tag" class="btn btn-outline">
        ← Voir toutes les étiquettes
      </a>
    </div>
  </div>
</BlogLayout>
